{
  "hash": "aaf6e90272077aa3c49c2fe5420fbbdd",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Semana 43\"\nsubtitle: \"Figura semana 43\"\nauthor: Víctor Gauto\ndate: \"2023-10-29\"\neditor_options:\n  chunk_output_type: console\ncategories: [geom_line, geom_point, geom_richtext]\nimage: https://raw.githubusercontent.com/vhgauto/tidytuesday/refs/heads/main/2023/semana_43/viz.png\nexecute:\n  eval: false\n  echo: true\ncode-fold: true\n---\n\n\n\n\n\n# Script\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# paquetes ----------------------------------------------------------------\n\nlibrary(tidyverse)\nlibrary(showtext)\nlibrary(glue)\nlibrary(ggtext)\n\n# fuente ------------------------------------------------------------------\n\n# colores\nMoMAColors::moma.colors(palette_name = \"Flash\") |> \n  as.character()\nc1 <- \"#E3C0DB\"\nc2 <- \"#41045A\"\nc3 <- \"#900C7E\"\nc4 <- \"#DB95CB\"\nc5 <- \"#140E3A\"\nc6 <- \"#C049A6\"\n\n# texto gral\nfont_add_google(name = \"Ubuntu\", family = \"ubuntu\")\n# rango de años, eje horizontal\nfont_add_google(name = \"Bebas Neue\", family = \"bebas\")\n# porcentajes, eje vertical\nfont_add_google(name = \"Victor Mono\", family = \"victor\", db_cache = FALSE)\n# título\nfont_add_google(name = \"Abril Fatface\", family = \"abril\")\n\n# íconos\nfont_add(\"fa-brands\", \"icon/Font Awesome 6 Brands-Regular-400.otf\")\nfont_add(\"fa-solids\", \"icon/Font Awesome 6 Free-Solid-900.otf\")\nfont_add(\"fa-regular\", \"icon/Font Awesome 6 Free-Regular-400.otf\")\n\nshowtext_auto()\nshowtext_opts(dpi = 300)\n\n# caption\nfuente <- glue(\n  \"Datos: <span style='color:{c3};'><span style='font-family:mono;'>\",\n  \"{{<b>tidytuesdayR</b>}}</span> semana 43. \",\n  \"R/Pharma Conference, \",\n  \"**Jenna Reps**</span>\")\nautor <- glue(\"Autor: <span style='color:{c3};'>**Víctor Gauto**</span>\")\nicon_twitter <- glue(\"<span style='font-family:fa-brands;'>&#xf099;</span>\")\nicon_github <- glue(\"<span style='font-family:fa-brands;'>&#xf09b;</span>\")\nusuario <- glue(\"<span style='color:{c3};'>**vhgauto**</span>\")\nsep <- glue(\"**|**\")\n\nmi_caption <- glue(\n  \"{fuente}<br>{autor} {sep} {icon_github} {icon_twitter} {usuario}\")\n\n# datos -------------------------------------------------------------------\n\nbrowseURL(\"https://github.com/rfordatascience/tidytuesday/blob/master/data/2023/2023-10-24/readme.md\")\n\npatient_risk_profiles <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2023/2023-10-24/patient_risk_profiles.csv')\n\n# me interesa el riesgo de padecer sordera, demencia y Parkinson\n\n# rangos de edad, como factores\nrango_orden <- patient_risk_profiles |> \n  select(contains(\"age group\")) |> \n  pivot_longer(cols = everything()) |> \n  distinct(rango = name) |> \n  mutate(rango = str_remove(rango, \"age group:  \")) |> \n  mutate(rango = str_remove_all(rango, \" \")) |> \n  separate_wider_delim(\n    rango, delim = \"-\", names = c(\"i_rango\", NA), cols_remove = FALSE) |> \n  mutate(i_rango = as.numeric(i_rango)) |> \n  mutate(rango = fct_reorder(rango, i_rango)) |> \n  arrange(rango)\n\n# enfermedades de interés\nenfermedad <- c(\n  \"predicted risk of Sudden Hearing Loss, No congenital anomaly or middle or inner ear conditions\",\n  \"predicted risk of Dementia\",\n  \"predicted risk of Parkinson's disease, inpatient or with 2nd diagnosis\")\n\n# agrupo por enfermedad y rango de edad\nd <- patient_risk_profiles |>\n  select(any_of(enfermedad), contains(\"age group\")) |>\n  select(oido = 1, demencia = 2, parkinson = 3, everything()) |> \n  pivot_longer(\n    cols = -c(oido, demencia, parkinson),\n    names_to = \"rango\", \n    values_to = \"es_rango\") |>\n  pivot_longer(\n    cols = -c(rango, es_rango),\n    names_to = \"enfermedad\",\n    values_to = \"frac_enfermedad\") |>\n  mutate(rango = str_remove(rango, \"age group:  \")) |>\n  mutate(rango = str_remove_all(rango, \" \")) |> \n  filter(es_rango == 1) |>\n  mutate(rango = fct(rango, levels = as.character(rango_orden$rango))) |> \n  arrange(rango) |> \n  mutate(rango = fct_inorder(rango)) |> \n  reframe(\n    n_rango = n(),\n    frac_enfermedad = mean(frac_enfermedad),\n    .by = c(rango, enfermedad)) |> \n  arrange(rango) |> \n  mutate(rango = fct_inorder(rango))\n\n# figura ------------------------------------------------------------------\n\n# etiquetas de las enfermedades para cada línea\netq_tbl <- tibble(\n  enf = c(\"demencia\", \"sordera\", \"parkinson\") |> str_to_upper(),\n  color = c(c6, c3, c2),\n  x = c(3, 3, 14),\n  y = c(0.012, .15, .078)/100,\n  angle = c(60, 30, 0)) |> \n  mutate(label = glue(\"<b style='color:{color}'>{enf}</b>\"))\n\n# título y subtítulo\ng_tit <- glue(\"Los años no vienen solos\")\ng_sub <- glue(\n  \"A partir de los datos simulados de **100** pacientes, se<br>\",\n  \"muestra el riesgo (en %) de padecer <b style='color:{c6}'>demencia</b>, <br>\",\n  \"<b style='color:{c3}'>sordera</b> y <b style='color:{c2}'>Parkinson</b>, \",\n  \"para diferentes rangos de edad.\")\n\n# figura\ng <- ggplot(d, aes(rango, frac_enfermedad, color = enfermedad, group = enfermedad)) +\n  geom_line(\n    show.legend = FALSE, linewidth = 2.5, alpha = .6) +\n  geom_point(\n    show.legend = FALSE, alpha = 1) +\n  geom_richtext(\n    data = etq_tbl, aes(x, y, label = label, angle = angle), show.legend = FALSE,\n    inherit.aes = FALSE, hjust = 0, vjust = 1, label.color = NA, fill = NA,\n    family = \"ubuntu\", size = 5) +\n  annotate(\n    geom = \"richtext\", label = g_tit, color = c5, x = 1, y = .1,\n    hjust = 0, vjust = 0, family = \"abril\", size = 19, fill = NA, \n    label.color = NA) +\n  annotate(\n    geom = \"richtext\", label = g_sub, color = c2, x = 1, y = .1,\n    hjust = 0, vjust = 1, family = \"ubuntu\", size = 7, fill = NA, \n    label.color = NA) +\n  scale_color_manual(values = c(c6, c3, c2)) +\n  scale_y_log10(labels = scales::label_percent(\n    big.mark = \"\", decimal.mark = \",\")) +\n  coord_cartesian(clip = \"off\") +\n  labs(caption = mi_caption) +\n  guides(\n    x = guide_axis(n.dodge = 2)) +\n  theme_void() +\n  theme(\n    aspect.ratio = 1,\n    plot.margin = margin(20, 16.3, 5, 16.3),\n    plot.background = element_rect(\n      fill = c1, color = c2, linewidth = 3),\n    plot.caption = element_markdown(\n      family = \"ubuntu\", margin = margin(25, 0, 5, 0), size = 12),\n    axis.text = element_text(color = c5),\n    axis.text.x = element_text(\n      margin = margin(5, 0, 0, 0), size = 21, family = \"bebas\"),\n    axis.text.y = element_text(\n      vjust = 0, margin = margin(0, 5, 0, 0), family = \"victor\", size = 15),\n    panel.grid.major.x = element_line(\n      color = c4, linetype = 3, linewidth = .2),\n    panel.grid.major.y = element_line(\n      color = c4, linetype = 1, linewidth = .2),\n    panel.grid.minor.y = element_line(\n      color = c4, linetype = \"ff\", linewidth = .2)\n  )\n\n# guardo\nggsave(\n  plot = g,\n  filename = \"2023/semana_43/viz.png\",\n  width = 30,\n  height = 31,\n  units = \"cm\")\n\n# abro\nbrowseURL(\"2023/semana_43/viz.png\")\n```\n:::\n\n\n\n\n# Figura\n\n![](https://raw.githubusercontent.com/vhgauto/tidytuesday/refs/heads/main/2023/semana_43/viz.png)\n\n\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}