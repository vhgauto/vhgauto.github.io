{
  "hash": "117d972375d995361e3d59818a0eba6c",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Semana 46\"\nsubtitle: \"Figura semana 46\"\nauthor: Víctor Gauto\ndate: \"2023-11-19\"\neditor_options:\n  chunk_output_type: console\ncategories: [geom_sf_pattern, geom_sf]\nimage: https://raw.githubusercontent.com/vhgauto/tidytuesday/refs/heads/main/2023/semana_46/viz.png\nexecute:\n  eval: false\n  echo: true\ncode-fold: true\n---\n\n\n\n\nVentas per cápita por el festival Diwali.\n\n# Script\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# paquetes ----------------------------------------------------------------\n\nlibrary(tidyverse)\nlibrary(sf)\nlibrary(ggpattern)\nlibrary(fontawesome)\nlibrary(showtext)\nlibrary(glue)\nlibrary(ggtext)\nlibrary(rgeoboundaries)\n\n# fuente ------------------------------------------------------------------\n\n# colores\nc1 <- \"#FEC200\"\nc2 <- \"#F78608\"\nc3 <- \"white\"\nc4 <- \"#E6172F\"\nc5 <- \"#D20983\"\nc6 <- \"#C301C5\"\nc7 <- \"#EE3711\"\nc8 <- \"grey80\"\nc9 <- \"grey90\"\n\n# texto gral\nfont_add_google(name = \"Ubuntu\", family = \"ubuntu\")\n# algoritmos, eje vertical\nfont_add_google(name = \"IBM Plex Mono\", family = \"ibm\", db_cache = FALSE)\n# título\nfont_add_google(name = \"Agbalumo\", family = \"agbalumo\", db_cache = FALSE)\n\n# íconos\nfont_add(\"fa-brands\", \"icon/Font Awesome 6 Brands-Regular-400.otf\")\nfont_add(\"fa-solids\", \"icon/Font Awesome 6 Free-Solid-900.otf\")\nfont_add(\"fa-regular\", \"icon/Font Awesome 6 Free-Regular-400.otf\")\n\nshowtext_auto()\nshowtext_opts(dpi = 300)\n\n# caption\nfuente <- glue(\n  \"Datos: <span style='color:{c3};'><span style='font-family:mono;'>\",\n  \"{{<b>tidytuesdayR</b>}}</span> semana 46. \",\n  \"Diwali Sales Dataset, \",\n  \"**Saad Haroon**</span>\")\nautor <- glue(\"Autor: <span style='color:{c3};'>**Víctor Gauto**</span>\")\nicon_twitter <- glue(\"<span style='font-family:fa-brands;'>&#xf099;</span>\")\nicon_github <- glue(\"<span style='font-family:fa-brands;'>&#xf09b;</span>\")\nusuario <- glue(\"<span style='color:{c3};'>**vhgauto**</span>\")\nsep <- glue(\"**|**\")\n\nmi_caption <- glue(\n  \"{fuente}<br>{autor} {sep} {icon_github} {icon_twitter} {usuario}\")\n\n# datos -------------------------------------------------------------------\n\nbrowseURL(\"https://github.com/rfordatascience/tidytuesday/blob/master/data/2023/2023-11-14/readme.md\")\n\ndiwali <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2023/2023-11-14/diwali_sales_data.csv')\n\n# mapa de consumo per cápita por cada estado de India\n# 1ro considero sumar el gasto de cada usuario, y luego hacer el promedio por \n# cada estado\n\nd <- diwali |> \n  reframe(\n    prom = sum(Amount, na.rm = TRUE),\n    .by = c(User_ID, State)) |> \n  reframe(\n    prom = sum(prom, na.rm = TRUE)/n(),\n    .by = State) |> \n  rename(estado = State)\n\n# India, como país y con sus estados\nindia <- gb_adm1(country = \"India\")\nindia0 <- gb_adm0(country = \"India\")\n\n# cambio de CRS y arreglo los nombres\nindia_sf <- india |> \n  select(estado = shapeName) |> \n  mutate(estado = str_replace_all(estado, \"ā\", \"a\")) |> \n  st_transform(crs = 7755)\n\n# combino los datos de consumo con el mapa\nd_sf <- full_join(d, india_sf, by = join_by(estado)) |> \n  st_as_sf()\n\n# estados sin datos\nd_na <- d_sf |> \n  filter(is.na(prom)) |> \n  st_as_sf()\n\n# caja como referencia de los estados sin datos\n# ubicación\nxmin <- 4400000\nymin <- 2000000\nxmax <- xmin + 200000\nymax <- ymin + 200000\n\ncaja <- st_sfc(\n  st_polygon(\n    list(\n      cbind(c(xmin, xmax, xmax, xmin, xmin), c(ymin, ymin, ymax, ymax, ymin)))), \n  crs = 7755) |> \n  st_as_sf()\n\n# figura ------------------------------------------------------------------\n\n# círculo alrededor de India\ncirc <- st_centroid(india0) |>\n  st_transform(crs = 7755) |> \n  st_as_sf() |> \n  st_buffer(dist = 1900000, nQuadSegs = 200)\n\n# título y subtítulo\nmi_tit <- \"Diwali\"\nmi_tit2 <- \"El festival de las luces\"\n\nmi_sub <- glue(\n  \"Consumo per cápita\",\n  \"en rupias, durante\",\n  \"el festival <b style='color:{c1}'>Dwali</b>\",\n  \"en **India**.\",\n  .sep = \"<br>\")\n\n# figura\ng <- ggplot() +\n  # círculo de fondo\n  geom_sf_pattern(\n    data = circ, \n    color = NA, pattern = \"gradient\",\n    pattern_orientation = \"radial\", \n    pattern_fill = c1, # centro\n    pattern_fill2 = c5, # exterior\n    pattern_density = 1) +\n  # India\n  geom_sf(data = d_sf, aes(fill = prom), color = NA) +\n  # estados sin datos\n  geom_sf_pattern(\n    data = d_na, pattern = \"stripe\", show.legend = FALSE, color = NA,\n    fill = c8, pattern_spacing = 0.01, pattern_density = 0.4, \n    pattern_fill = c9, pattern_color  = NA, pattern_angle = 45) +\n  # contorno de los estados\n  geom_sf(data = d_sf, fill = NA, color = \"black\", linewidth = .2) +\n  # caja\n  geom_sf_pattern(\n    data = caja, pattern = \"stripe\", show.legend = FALSE, color = c4,\n    fill = c8, pattern_spacing = 0.01, pattern_density = 0.4, \n    pattern_fill = c9, pattern_color  = NA, pattern_angle = 45,\n    linewidth = .1) +\n  annotate(\n    geom = \"text\", x = xmax+10000, y = ymin, label = \"Estados sinndatos\",\n    hjust = 0, vjust = 0, family = \"ubuntu\", color = \"white\", size = 6) +\n  # título\n  annotate(\n    geom = \"richtext\", x = 3943500, y = 5590000, label = mi_tit, size = 30,\n    family = \"agbalumo\", hjust = .5, vjust = 0, color = c1, fill = NA,\n    label.color = NA) +\n  annotate(\n    geom = \"richtext\", x = 3943500, y = 5670000, label = mi_tit2, size = 10,\n    family = \"agbalumo\", hjust = .5, vjust = 1, color = c9, fill = NA,\n    label.color = NA) +\n  coord_sf(clip = \"off\") +\n  scale_fill_viridis_c(\n    option = \"turbo\", na.value = NA, limits = c(8000, 14000),\n    labels = scales::label_dollar(\n      big.mark = \".\", decimal.mark = \",\", prefix = \"₹ \", scale = 1)) +\n  labs(caption = mi_caption, fill = mi_sub) +\n  guides(\n    fill = guide_colorbar(\n      frame.colour = \"white\", ticks.colour = \"white\", ticks.linewidth = .5)) +\n  theme_void() +\n  theme(\n    plot.background = element_rect(fill = c6, color = c7, linewidth = 3),\n    plot.margin = margin(15.7, 0, 5.7, 0),\n    plot.title = element_text(\n      family = \"playball\", size = 55, color = c1, margin = margin(15, 0, 0, 0)),\n    plot.caption = element_markdown(\n      family = \"ubuntu\", color = c1, margin = margin(0, 10, 10, 0), size = 12),\n    legend.position = c(.05, .05),\n    legend.justification = c(0, 0),\n    legend.text = element_text(\n      hjust = 1, family = \"ibm\", color = \"white\", face = \"bold\", size = 14),\n    legend.title = element_markdown(\n      family = \"ubuntu\", color = \"white\", size = 18, \n      margin = margin(0, 0, 10, 0)),\n    legend.key.height = unit(1.1, \"cm\"))\n\n# guardo\nggsave(\n  plot = g,\n  filename = \"2023/semana_46/viz.png\",\n  width = 30,\n  height = 32,\n  units = \"cm\")\n\n# abro\nbrowseURL(\"2023/semana_46/viz.png\")\n```\n:::\n\n\n\n\n# Figura\n\n![](https://raw.githubusercontent.com/vhgauto/tidytuesday/refs/heads/main/2023/semana_46/viz.png)\n\n\n",
    "supporting": [
      "semana_46_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}