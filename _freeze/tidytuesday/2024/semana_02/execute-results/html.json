{
  "hash": "f0836d104948c6a3be6d1b5a3350416b",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Semana 02\"\nsubtitle: \"Figura semana 02\"\nauthor: Víctor Gauto\ndate: \"2024-01-15\"\neditor_options:\n  chunk_output_type: console\ncategories: [geom_segment, geom_line, geom_point, geom_label, geom_text, geom_richtext]\nimage: https://raw.githubusercontent.com/vhgauto/tidytuesday/refs/heads/main/2024/s02/viz.png\nexecute:\n  eval: false\n  echo: true\ncode-fold: true\n---\n\n\n\n\n\n# Script\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# paquetes ----------------------------------------------------------------\n\nlibrary(glue)\nlibrary(ggtext)\nlibrary(showtext)\nlibrary(tidyverse)\n\n# fuente ------------------------------------------------------------------\n\nMetBrewer::met.brewer(name = \"VanGogh2\")\nMetBrewer::met.brewer(name = \"Benedictus\")\n\n# colores\nc1 <- \"#F9E0E8\"\nc2 <- \"#D8527C\"\nc3 <- \"#9A133D\"\nc4 <- \"#BD3107\"\nc5 <- \"#D9700F\"\nc6 <- \"#454B87\"\nc7 <- \"#89A6BB\"\nc8 <- \"#F9B4C9\"\n\n# texto gral\nfont_add_google(name = \"Ubuntu\", family = \"ubuntu\")\n# horas, días\nfont_add_google(name = \"Victor Mono\", family = \"victor\", db_cache = FALSE)\n\n# íconos\nfont_add(\"fa-brands\", \"icon/Font Awesome 6 Brands-Regular-400.otf\")\n\nshowtext_auto()\nshowtext_opts(dpi = 300)\n\n# caption\nfuente <- glue(\n  \"Datos: <span style='color:{c3};'><span style='font-family:mono;'>\",\n  \"{{<b>tidytuesdayR</b>}}</span> semana 2. \",\n  \"Statistics Canada & NHL API.</span>\")\nautor <- glue(\"<span style='color:{c3};'>**Víctor Gauto**</span>\")\nicon_twitter <- glue(\"<span style='font-family:fa-brands;'>&#xf099;</span>\")\nicon_github <- glue(\"<span style='font-family:fa-brands;'>&#xf09b;</span>\")\nicon_mastodon <- glue(\"<span style='font-family:fa-brands;'>&#xf4f6;</span>\")\nusuario <- glue(\"<span style='color:{c3};'>**vhgauto**</span>\")\nsep <- glue(\"**|**\")\n\nmi_caption <- glue(\n  \"{fuente}<br>{autor} {sep} {icon_github} {icon_twitter} {icon_mastodon} \n  {usuario}\")\n\n# datos -------------------------------------------------------------------\n\nbrowseURL(\"https://github.com/rfordatascience/tidytuesday/blob/master/data/2024/2024-01-09/readme.md\")\n\ntuesdata <- tidytuesdayR::tt_load(2024, week = 2)\n\n# me interesa las diferencias entre el porcentaje de nacimientos por mes, entre\n# la población general de Canadá y los integrantes de la NHL\ncanada <- tuesdata$canada_births_1991_2022\nnhl <- tuesdata$nhl_player_births\n\n# etiquetas de los meses\nmeses <- ymd(glue(\"2020-{1:12}-01\")) |> \n  format(\"%b\") |> \n  str_to_upper() |> \n  str_remove(pattern = \"\\.\")\n\nnames(meses) <- 1:12\n\n# datos de Canadá\nd_canada <- canada |> \n  reframe(\n    suma_mes = sum(births),\n    .by = month) |> \n  mutate(porcent = suma_mes/sum(suma_mes)*100) |> \n  select(mes = month, porcent) |> \n  mutate(tipo = \"Canadá\")\n\nd_nhl <- nhl |> \n  count(birth_month) |> \n  mutate(porcent = n/sum(n)*100) |> \n  select(mes = birth_month, porcent) |> \n  mutate(tipo = \"NHL\")\n\n# porcentajes de nacimientos por mes, de la población de Canadá y NHL\nd <- bind_rows(d_canada, d_nhl) |> \n  mutate(color = if_else(tipo == \"Canadá\", c4, c6))\n\n# tabla ancha, para agregar etiquetas de cambio de porcentajes y flechas\nd2 <- d |> \n  select(-color) |> \n  pivot_wider(names_from = tipo, values_from = porcent) |> \n  mutate(dif = NHL - Canadá) |> \n  mutate(y_medio = Canadá + dif/2) |> \n  mutate(label = format(dif, digits = 2)) |> \n  mutate(label = str_replace(label, \"\\.\", \",\")) |> \n  mutate(label = str_replace(label, \" \", \"+\")) |> \n  mutate(color = if_else(dif > 0, c5, c7)) |> \n  mutate(NHL = ifelse(dif > 0, NHL*.995, NHL*1.005)) |> \n  mutate(y_mes = if_else(Canadá < NHL, Canadá, NHL)) |> \n  mutate(label_mes = meses[mes]) |> \n  mutate(label_mes = str_split(label_mes, \"\")) |> \n  mutate(label_mes = map(label_mes, ~ str_flatten(.x, collapse = \"n\"))) |> \n  unnest(label_mes)\n\n# figura ------------------------------------------------------------------\n\nmi_subtitle <- glue(\n  \"Diferencias en el porcentaje de nacimientos<br>\",\n  \"mensuales, entre la población general de <b style='color:{c4}'>Canadá</b><br>\",\n  \"y los jugadores de la <b style='color:{c6}'>National Hockey League</b>.<br>\",\n  \"Se indica en cada mes si la diferencia es <b style='color:{c5}'>positiva</b> o<br>\",\n  \"<b style='color:{c7}'>negativa</b>. En la **NHL** hay una una mayor presencia<br>\",\n  \"de nacidos a principio de año que en el resto<br>\",\n  \"de la población.\"\n)\n\ni_canada <- \"2024/s01/i_canada.png\"\ni_nhl <- \"2024/s01/i_nhl.png\"\n\ni_y1 <- d[d$mes == 1 & d$tipo == \"NHL\",]$porcent\ni_y2 <- d[d$mes == 12 & d$tipo == \"Canadá\",]$porcent\n\ni_tbl <- tibble(img = c(i_nhl, i_canada)) |> \n  mutate(label = glue(\"<img src={img} height='50'>\")) |> \n  mutate(x = c(1, 12), y = c(i_y1, i_y2))\n\ng <- ggplot(d, aes(mes, porcent)) +\n  # flechas\n  geom_segment(\n    data = d2, \n    aes(x = mes, xend = mes, y = Canadá, yend = NHL, color = color),\n    arrow = arrow(angle = 20, length = unit(3, \"mm\"), type = \"open\"), \n    linewidth = 1) +\n  # líneas\n  geom_line(aes(color = color), linewidth = 3) +\n  # puntos\n  geom_point(aes(color = color), size = 4) +\n  geom_point(color = c1, size = 2) +\n  # porcentaje de cambio\n  geom_label(\n    data = d2, aes(\n      mes, y_mes, label = label, fill = alpha(color, .6)), hjust = .5, \n    nudge_x = 0, nudge_y = -.45, family = \"victor\", size = 4, color = \"black\",\n    label.size = unit(0, \"mm\"), vjust = 1) +\n  # meses\n  geom_text(\n    data = d2, aes(mes, y_mes, label = label_mes), family = \"ubuntu\", \n    color = c2, nudge_y = -.28, fontface = \"italic\", size = 6,\n    lineheight = unit(.8, \"line\")) +\n  # imágenes de NHL & Canadá\n  geom_richtext(\n    data = i_tbl, aes(x, y, label = label), fill = NA, label.color = NA, \n    vjust = 0, nudge_y = .03) +\n  # subtítulo\n  annotate(\n    geom = \"richtext\", x = 6.5, y = 11, label = mi_subtitle, hjust = 0, vjust = 1,\n    color = \"black\", fill = NA, label.color = NA, family = \"ubuntu\", size = 6) +\n  # epígrafe\n  annotate(\n    geom = \"richtext\", x = 1, y = 6, label = mi_caption, hjust = 0, vjust = 0,\n    color = \"black\", fill = NA, label.color = NA, family = \"ubuntu\", size = 4) +\n  scale_x_continuous(breaks = 1:12, labels = meses, limits = c(.9, 12.7)) +\n  scale_y_continuous(\n    limits = c(6, 11), breaks = 6:11, \n    labels = scales::label_number(suffix = \"%\")) +\n  scale_color_identity() +\n  scale_fill_identity() +\n  coord_cartesian(clip = \"off\", expand = FALSE) +\n  theme_void() +\n  theme(\n    aspect.ratio = 1,\n    plot.margin = margin(28.5, 10, 28.5, 10),\n    plot.background = element_rect(fill = c1, color = c8, linewidth = 3),\n    plot.subtitle = element_markdown(family = \"ubuntu\"),\n    plot.caption = element_markdown(family = \"ubuntu\"),\n    panel.background = element_blank(),\n    panel.grid.minor = element_blank(),\n    panel.grid.major.y = element_line(\n      linetype = 2, linewidth = .5, color = c8),\n    axis.text.y = element_text(\n      family = \"victor\", size = 15, margin = margin(r = 10), color = c3)\n  )\n\n# guardo\nggsave(\n  plot = g,\n  filename = \"2024/s02/viz.png\",\n  width = 30,\n  height = 30,\n  units = \"cm\")\n\n# abro\nbrowseURL(\"2024/s02/viz.png\")\n```\n:::\n\n\n\n\n# Figura\n\n![](https://raw.githubusercontent.com/vhgauto/tidytuesday/refs/heads/main/2024/s02/viz.png)\n\n\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}